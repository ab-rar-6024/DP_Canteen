{% extends "department/layout.html" %}
{% block content %}

<div class="card p-4 shadow-sm">
<h5 class="text-center mb-3">User Password Management</h5>

<div class="row mb-3">
    <div class="col-md-4">
        <label>Select Department</label>
        <select class="form-control" onchange="loadUsers(this.value)">
            <option value="">Select</option>
            <option value="IT">IT</option>
            <option value="HR">HR</option>
            <option value="Finance">Finance</option>
            <option value="canteen">Canteen</option>
        </select>
    </div>
</div>

<table class="table table-bordered table-sm" id="userTable" style="display:none;">
<thead class="table-light">
<tr>
    <th>Username</th>
    <th>Current Password</th>
    <th>New Password</th>
    <th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script>
function loadUsers(dept){
    if(!dept) return;

    fetch(`/department/get-users/${dept}`)
        .then(res => res.json())
        .then(data => {
            const tbody = document.querySelector("#userTable tbody");
            tbody.innerHTML = "";

            if(data.length === 0){
                alert("No users found");
                return;
            }

            data.forEach(u => {
                tbody.innerHTML += `
                    <tr>
                        <td>${u.username}</td>
                        <td>${u.password}</td>
                        <td>
                            <input class="form-control"
                                   id="pw_${u.id}"
                                   placeholder="New password">
                        </td>
                        <td>
                            <button class="btn btn-success btn-sm"
                                onclick="savePassword(${u.id})">
                                Save
                            </button>
                        </td>
                    </tr>
                `;
            });

            document.getElementById("userTable").style.display = "table";
        });
}

function savePassword(id){
    const pw = document.getElementById(`pw_${id}`).value;
    if(!pw){
        alert("Enter new password");
        return;
    }

    fetch("/department/update-password", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `user_id=${id}&new_password=${pw}`
    })
    .then(res => res.json())
    .then(() => {
        alert("Password updated successfully");
        document.getElementById(`pw_${id}`).value = "";
    });
}
</script>

{% endblock %}
